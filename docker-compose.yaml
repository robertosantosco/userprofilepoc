version: '3.8' 

services: 
  postgres-primary:
    build: .
    container_name: user-profile-primary-db
    ports: 
      - "5432:5432"
    environment:
      - POSTGRES_USER=poc_user
      - POSTGRES_PASSWORD=poc_password
      - POSTGRES_DB=user_profile_db
      - POSTGRES_REPLICATION_USER=replicator
      - POSTGRES_REPLICATION_PASSWORD=replicator_password
    command: >
      postgres
      -c wal_level=logical
      -c max_wal_senders=20
      -c max_replication_slots=10
      -c hot_standby=on
      -c archive_mode=on
      -c archive_command='test ! -f /var/lib/postgresql/archive/%f && cp %p /var/lib/postgresql/archive/%f'
      -c max_connections=200
      -c shared_buffers=512MB
      -c work_mem=16MB
      -c maintenance_work_mem=128MB
      -c effective_cache_size=1GB
    volumes:
      - postgres_primary_data:/var/lib/postgresql/data:rw
      - postgres_archive:/var/lib/postgresql/archive:rw
      - ./database/schema.sql:/tmp/schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U poc_user -d user_profile_db && psql -U poc_user -d user_profile_db -c \"SELECT COUNT(*) FROM pg_tables WHERE schemaname = 'public'\" | grep -q '3'"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped

  postgres-replica-1:
    build: .
    user: postgres
    container_name: user-profile-replica-1-db
    ports:
      - "5433:5432"
    environment:
      - PGUSER=poc_user
      - POSTGRES_PASSWORD=poc_password
      - POSTGRES_DB=user_profile_db
      - POSTGRES_REPLICATION_USER=replicator
      - POSTGRES_REPLICATION_PASSWORD=replicator_password
    command: >
      bash -c "
      rm -rf /var/lib/postgresql/data/* &&
      chown -R postgres:postgres /var/lib/postgresql/data &&
      chmod 700 /var/lib/postgresql/data &&
      until PGPASSWORD=replicator_password pg_basebackup -h postgres-primary -D /var/lib/postgresql/data -U replicator -v -P; do
        echo 'Waiting for primary to be available...'
        sleep 5
      done &&
      echo \"primary_conninfo = 'host=postgres-primary port=5432 user=replicator password=replicator_password'\" > /var/lib/postgresql/data/postgresql.auto.conf &&
      touch /var/lib/postgresql/data/standby.signal &&
      postgres -c hot_standby=on -c max_connections=200 -c shared_buffers=512MB -c max_wal_senders=20 -c max_replication_slots=10 -c wal_level=logical
      "
    volumes:
      - postgres_replica_1_data:/var/lib/postgresql/data:rw
    depends_on:
      postgres-primary:
        condition: service_healthy
    restart: unless-stopped

  postgres-replica-2:
    build: .
    user: postgres
    container_name: user-profile-replica-2-db
    ports:
      - "5434:5432"
    environment:
      - PGUSER=poc_user
      - POSTGRES_PASSWORD=poc_password
      - POSTGRES_DB=user_profile_db
      - POSTGRES_REPLICATION_USER=replicator
      - POSTGRES_REPLICATION_PASSWORD=replicator_password
    command: >
      bash -c "
      rm -rf /var/lib/postgresql/data/* &&
      chown -R postgres:postgres /var/lib/postgresql/data &&
      chmod 700 /var/lib/postgresql/data &&
      until PGPASSWORD=replicator_password pg_basebackup -h postgres-primary -D /var/lib/postgresql/data -U replicator -v -P; do
        echo 'Waiting for primary to be available...'
        sleep 5
      done &&
      echo \"primary_conninfo = 'host=postgres-primary port=5432 user=replicator password=replicator_password'\" > /var/lib/postgresql/data/postgresql.auto.conf &&
      touch /var/lib/postgresql/data/standby.signal &&
      postgres -c hot_standby=on -c max_connections=200 -c shared_buffers=512MB -c max_wal_senders=20 -c max_replication_slots=10 -c wal_level=logical
      "
    volumes:
      - postgres_replica_2_data:/var/lib/postgresql/data:rw
    depends_on:
      postgres-primary:
        condition: service_healthy
    restart: unless-stopped

  redis-node-1:
    image: redis:7-alpine
    ports:
      - "7001:7001"
      - "17001:17001"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '0.3'
    command: >
      redis-server
      --port 7001
      --cluster-enabled yes
      --cluster-config-file nodes-7001.conf
      --cluster-node-timeout 5000
      --cluster-announce-ip redis-node-1
      --cluster-announce-port 7001
      --cluster-announce-bus-port 17001
      --maxmemory 1500mb
      --maxmemory-policy allkeys-lru
      --appendonly no
      --save ""
      --tcp-keepalive 60
      --timeout 300
      --maxclients 5000
    volumes:
      - redis_node_1_data:/data

  redis-node-2:
    image: redis:7-alpine
    ports:
      - "7002:7002"
      - "17002:17002"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '0.3'
    command: >
      redis-server
      --port 7002
      --cluster-enabled yes
      --cluster-config-file nodes-7002.conf
      --cluster-node-timeout 5000
      --cluster-announce-ip redis-node-2
      --cluster-announce-port 7002
      --cluster-announce-bus-port 17002
      --maxmemory 1500mb
      --maxmemory-policy allkeys-lru
      --appendonly no
      --save ""
      --tcp-keepalive 60
      --timeout 300
      --maxclients 5000
    volumes:
      - redis_node_2_data:/data

  redis-node-3:
    image: redis:7-alpine
    ports:
      - "7003:7003"
      - "17003:17003"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '0.3'
    command: >
      redis-server
      --port 7003
      --cluster-enabled yes
      --cluster-config-file nodes-7003.conf
      --cluster-node-timeout 5000
      --cluster-announce-ip redis-node-3
      --cluster-announce-port 7003
      --cluster-announce-bus-port 17003
      --maxmemory 1500mb
      --maxmemory-policy allkeys-lru
      --appendonly no
      --save ""
      --tcp-keepalive 60
      --timeout 300
      --maxclients 5000
    volumes:
      - redis_node_3_data:/data

  redis-cluster-init:
    image: redis:7-alpine
    depends_on:
      - redis-node-1
      - redis-node-2
      - redis-node-3
    command: >
      sh -c "sleep 10 && redis-cli --cluster create redis-node-1:7001 redis-node-2:7002 redis-node-3:7003 --cluster-replicas 0 --cluster-yes"

  redis-insight:
    image: redislabs/redisinsight:latest
    ports:
      - "5540:5540"
    restart: unless-stopped
    environment:
      - REDIS_HOSTS=redis://default@redis-node-1:7001
    volumes:
      - redis_insight_data:/data
    depends_on:
      - redis-node-1
      - redis-node-2
      - redis-node-3
  
  kafka:
    image: bitnami/kafka:latest
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_ENABLE_KRAFT: "yes"
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_CFG_NODE_ID: "1"
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: "1@kafka:9093"
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_CFG_LISTENERS: "CLIENT_EXTERNAL://0.0.0.0:9092,CLIENT_INTERNAL://0.0.0.0:9094,CONTROLLER://0.0.0.0:9093"
      KAFKA_CFG_ADVERTISED_LISTENERS: "CLIENT_EXTERNAL://localhost:9092,CLIENT_INTERNAL://kafka:9094,CONTROLLER://kafka:9093"
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: "CLIENT_EXTERNAL:PLAINTEXT,CLIENT_INTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT"
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: "CLIENT_INTERNAL"
      KAFKA_LOG_DIRS: "/bitnami/kafka/data"
      KAFKA_CLUSTER_ID: "86f8dz3rTS-nMTEcUmjulA"

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAP_SERVERS: kafka:9094
    depends_on:
      - kafka

  debezium-connect:
    image: quay.io/debezium/connect:3.1
    container_name: user-profile-debezium-connect
    depends_on:
      kafka:
        condition: service_started
      postgres-primary:
        condition: service_healthy
    ports:
      - "8083:8083"
    environment:
      # Kafka Connection
      BOOTSTRAP_SERVERS: kafka:9094
      GROUP_ID: user-profile-connect-cluster

      # Connect Storage Topics
      CONFIG_STORAGE_TOPIC: user-profile-connect-configs
      OFFSET_STORAGE_TOPIC: user-profile-connect-offsets
      STATUS_STORAGE_TOPIC: user-profile-connect-statuses

      # Replication factors (1 for single broker)
      CONFIG_STORAGE_REPLICATION_FACTOR: 1
      OFFSET_STORAGE_REPLICATION_FACTOR: 1
      STATUS_STORAGE_REPLICATION_FACTOR: 1

      # JSON Converters without schemas for simplicity
      KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      KEY_CONVERTER_SCHEMAS_ENABLE: "false"
      VALUE_CONVERTER_SCHEMAS_ENABLE: "false"

      # Internal converters
      INTERNAL_KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      INTERNAL_VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      INTERNAL_KEY_CONVERTER_SCHEMAS_ENABLE: "false"
      INTERNAL_VALUE_CONVERTER_SCHEMAS_ENABLE: "false"

      # Heap settings for Debezium
      KAFKA_HEAP_OPTS: "-Xmx1G -Xms1G"

      # Connect REST settings
      REST_HOST_NAME: debezium-connect
      REST_PORT: 8083
      REST_ADVERTISED_HOST_NAME: debezium-connect
      REST_ADVERTISED_PORT: 8083

      # Plugin path
      CONNECT_PLUGIN_PATH: /kafka/connect

      # Logging
      CONNECT_LOG4J_ROOT_LOGLEVEL: INFO
      CONNECT_LOG4J_LOGGERS: "org.apache.kafka.connect.runtime.rest=WARN,org.reflections=ERROR"
    volumes:
      - debezium_connect_data:/kafka/connect
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/connectors"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  debezium-connector-setup:
    image: alpine/httpie:latest
    container_name: user-profile-debezium-setup
    depends_on:
      debezium-connect:
        condition: service_healthy
    restart: "no"
    entrypoint: sh
    command:
      - -c
      - |
        echo "üöÄ Setting up Debezium PostgreSQL connector for User Profile..."

        # Wait for Connect to be ready
        until http --check-status --timeout=30 GET http://debezium-connect:8083/connectors; do
          echo "‚è≥ Waiting for Kafka Connect to be ready..."
          sleep 5
        done

        echo "‚úÖ Kafka Connect is ready, creating connector..."

        # Create the User Profile PostgreSQL connector
        echo '{
          "name": "user-profile-postgres-connector",
          "config": {
            "connector.class": "io.debezium.connector.postgresql.PostgresConnector",
            "tasks.max": "1",

            "database.hostname": "postgres-primary",
            "database.port": "5432",
            "database.user": "poc_user",
            "database.password": "poc_password",
            "database.dbname": "user_profile_db",
            "database.server.name": "user-profile-db",

            "topic.prefix": "user-profile",
            "table.include.list": "public.entities,public.edges,public.temporal_properties.*",

            "include.schema.changes": "false",
            "snapshot.mode": "initial",
            "publication.autocreate.mode": "filtered",
            "slot.name": "user_profile_debezium_slot",
            "slot.drop.on.stop": "false",
            "plugin.name": "pgoutput",

            "value.converter": "org.apache.kafka.connect.json.JsonConverter",
            "value.converter.schemas.enable": "false",
            "key.converter": "org.apache.kafka.connect.json.JsonConverter",
            "key.converter.schemas.enable": "false",

            "transforms": "route",
            "transforms.route.type": "org.apache.kafka.connect.transforms.RegexRouter",
            "transforms.route.regex": "user-profile\\.public\\.(.*)",
            "transforms.route.replacement": "user-profile.cdc.all-tables",

            "heartbeat.interval.ms": "10000",
            "max.batch.size": "2048",
            "max.queue.size": "8192",

            "errors.tolerance": "none",
            "errors.log.enable": "true",
            "errors.log.include.messages": "true"
          }
        }' | http --check-status --timeout=60 POST http://debezium-connect:8083/connectors Content-Type:application/json

        if [ $? -eq 0 ]; then
          echo "‚úÖ User Profile Debezium connector created successfully!"
          echo "üìä Connector will capture changes from:"
          echo "   - public.entities"
          echo "   - public.edges"
          echo "   - public.temporal_properties"
          echo "üì§ All changes will be sent to topic: user-profile.cdc.all-tables"

          # Check connector status
          echo "üîç Checking connector status..."
          http GET http://debezium-connect:8083/connectors/user-profile-postgres-connector/status
        else
          echo "‚ùå Failed to create Debezium connector"
          exit 1
        fi

volumes:
  postgres_primary_data:
   driver: local
  postgres_replica_1_data:
    driver: local  
  postgres_replica_2_data:
    driver: local
  postgres_archive:
    driver: local
  redis_node_1_data:
    driver: local
  redis_node_2_data:
    driver: local
  redis_node_3_data:
    driver: local
  redis_insight_data:
    driver: local
  debezium_connect_data:
    driver: local